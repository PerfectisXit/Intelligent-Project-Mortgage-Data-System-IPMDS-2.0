# IPMDS v0.2.1 发布说明（中文）

发布日期：2026-02-15  
对比基线：GitHub 当前版本（`origin/main`）

本次版本重点围绕三条主线：
1. AI 服务商配置可用性与可理解性提升（尤其是 `z.ai` 常规与 Coding Plan 分离）
2. 导入错误可运营化处理（支持逐条手动修正并确认）
3. 导入质量校验增强（手机号/身份证误填识别）

## 一、AI 服务商配置升级

### 1) 服务商配置 UI 重构
- 设置页改为“服务商下拉选择 + 单服务商配置”模式，避免长页面和多卡片干扰。
- 模型输入支持“预设选择 + 自定义输入”。
- Base URL 支持预设一键套用。

### 2) `z.ai` 常规 API 与 Coding Plan 独立
- 新增独立 provider：`zai_coding`。
- `zai` 与 `zai_coding` 的以下项均独立：
  - 启用开关
  - API Key
  - Base URL
  - 默认模型
  - 探测结果
- 解决了此前“同一开关同开同关”的问题。

### 3) 探测链路与结果判定优化
- 一键探测仅处理“已启用且配置完整（API Key + Base URL）”的 provider。
- 未配置完整 provider 自动跳过并提示名单。
- 探测结果提示严格区分成功/失败。
- 后端探测逻辑修复：即使 HTTP 2xx，若响应体包含 `error` 也判定失败。

### 4) `z.ai` 端点兼容修复
- 常规 API：`/api/paas/v4/chat/completions`
- Coding Plan：`/api/coding/paas/v4/chat/completions`
- 适配范围：Copilot 调用、表头复核、可用性探测。

## 二、导入错误处理能力升级

### 1) 错误可筛选可定位
- 导入比对表支持点击“新增/变更/无变化/错误”标签直接筛选。
- 错误详情可稳定显示 `errorMessage`（即使 `fieldDiffs` 为空）。

### 2) 新增逐条手动修正并确认
- 新增接口：`POST /api/v1/imports/{id}/rows/{rowNo}/manual-fix`
- 可将单条 `ERROR` 行修正为 `NEW` 或 `CHANGED` 并写回导入日志行。
- 修正后自动重算并更新摘要计数（总行数/新增/变更/无变化/错误）。

### 3) 手动修正 UI 体验提升
- 提供两种编辑模式：
  - 字段表单（默认）
  - JSON（高级）
- 字段名显示为“中文名（英文键）”，降低理解门槛。
- 修正失败时前端会显示后端真实错误信息，避免“点击无反应”。

## 三、导入校验规则增强

Python diff 校验新增：
- 识别“联系方式中疑似身份证号”
- 识别“身份证号中疑似手机号”
- 身份证号格式合法性校验（15/18位）

这补齐了“电话/身份证错位填值”场景下漏检问题。

## 四、Mock 模式配置持久化与升级兼容

- 新增本地持久化文件：`.run/ai-provider-settings.mock.json`
- 在 `MOCK_MODE` 下即使后端重启，服务商配置不会丢失。
- 读取旧配置时自动 merge 默认 provider，确保新增 provider（如 `zai_coding`）自动补齐可见。

## 五、升级提示

1. 若你是旧配置升级，刷新后若看到新增 provider（`zai_coding/deepseek/claude`）属于正常。  
2. 若使用 `z.ai Coding Plan`，请在服务商选择中选 `z.ai（Coding Plan）`，并填写对应 key。  
3. 导入流程建议先处理 `ERROR` 行（手动修正），再执行 `commit`。  

